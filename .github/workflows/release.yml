name: Release (APK)

on:
  workflow_dispatch:
  push:
    branches: [master, main]
    paths:
      - app/build.gradle.kts

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect version change
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          extract_version() {
            grep -oP 'versionName\s*=\s*"\K[^"]+' | head -n1 || true
          }

          current="$(extract_version < app/build.gradle.kts)"
          if [[ -z "$current" ]]; then
            echo "Failed to detect versionName in app/build.gradle.kts" >&2
            exit 1
          fi

          previous=""
          if [[ "${{ github.event_name }}" == "push" ]]; then
            before="${{ github.event.before }}"
            if git cat-file -e "$before:app/build.gradle.kts" 2>/dev/null; then
              previous="$(git show "$before:app/build.gradle.kts" | extract_version)"
            fi
          fi

          changed="false"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            changed="true"
          elif [[ -z "$previous" || "$current" != "$previous" ]]; then
            changed="true"
          fi

          echo "current=$current" >> "$GITHUB_OUTPUT"
          echo "previous=$previous" >> "$GITHUB_OUTPUT"
          echo "changed=$changed" >> "$GITHUB_OUTPUT"
          echo "tag=v$current" >> "$GITHUB_OUTPUT"

      - name: Stop (no version bump)
        if: steps.ver.outputs.changed != 'true'
        shell: bash
        run: |
          echo "No version bump detected: '${{ steps.ver.outputs.previous }}' -> '${{ steps.ver.outputs.current }}'. Skip release."

      - name: Set up JDK 17
        if: steps.ver.outputs.changed == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        if: steps.ver.outputs.changed == 'true'
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        if: steps.ver.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          yes | sdkmanager --licenses >/dev/null
          sdkmanager "platforms;android-34" "build-tools;34.0.0"

      - name: Set up Gradle
        if: steps.ver.outputs.changed == 'true'
        uses: gradle/actions/setup-gradle@v4

      - name: Decode signing keystore
        if: steps.ver.outputs.changed == 'true'
        shell: bash
        env:
          SIGNING_KEYSTORE_BASE64: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          if [[ -z "${SIGNING_KEYSTORE_BASE64:-}" ]]; then
            echo "Missing secret SIGNING_KEYSTORE_BASE64" >&2
            exit 1
          fi
          printf '%s' "$SIGNING_KEYSTORE_BASE64" | tr -d '\n\r' | base64 --decode > signing.keystore
          chmod 600 signing.keystore

      - name: Build signed release APK
        if: steps.ver.outputs.changed == 'true'
        shell: bash
        env:
          SIGNING_KEYSTORE_FILE: ${{ github.workspace }}/signing.keystore
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        run: |
          set -euo pipefail
          ./gradlew --no-daemon :app:assembleRelease

      - name: Collect artifacts
        if: steps.ver.outputs.changed == 'true'
        id: artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          apk="app/build/outputs/apk/release/app-release.apk"
          if [[ ! -f "$apk" ]]; then
            echo "APK not found: $apk" >&2
            ls -R app/build/outputs || true
            exit 1
          fi

          out="dist/fcitx5-syncclipboard-${{ steps.ver.outputs.current }}.apk"
          cp "$apk" "$out"
          sha256sum "$out" | awk '{print $1}' > "${out}.sha256"

          echo "apk=$out" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: steps.ver.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          generate_release_notes: true
          files: |
            dist/*
